name: Build Client Package

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*.*.*'  # åŒ¹é…ç‰ˆæœ¬ tagï¼Œå¦‚ v0.1.2
    paths:
      - 'client/**'
      - '.github/workflows/build-client.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'client/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆå¯é€‰ï¼Œå¦‚ 0.1.2ï¼‰'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç ï¼ˆåŒ…å« tag ä¿¡æ¯ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼ŒåŒ…æ‹¬ tag ä¿¡æ¯
      
      - name: æå–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # ä» tag ä¸­æå–ç‰ˆæœ¬å·ï¼ˆç§»é™¤ refs/tags/ å‰ç¼€ï¼Œç„¶åç§»é™¤ v å‰ç¼€ï¼‰
            VERSION="${GITHUB_REF#refs/tags/}"
            # å¦‚æœç‰ˆæœ¬å·ä»¥ v å¼€å¤´ï¼Œç§»é™¤ v å‰ç¼€
            if [[ "$VERSION" =~ ^v ]]; then
              VERSION="${VERSION#v}"
            fi
            echo "ğŸ·ï¸  ä» tag æå–çš„ç‰ˆæœ¬: $VERSION (åŸå§‹: ${{ github.ref }})"
          elif [[ -n "${{ inputs.version }}" ]]; then
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬å·
            VERSION="${{ inputs.version }}"
            # å¦‚æœç‰ˆæœ¬å·ä»¥ v å¼€å¤´ï¼Œç§»é™¤ v å‰ç¼€
            if [[ "$VERSION" =~ ^v ]]; then
              VERSION="${VERSION#v}"
            fi
            echo "âœ‹ ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬: $VERSION"
          else
            # ä» pyproject.toml ä¸­æå–ç‰ˆæœ¬å·
            VERSION=$(grep -E '^version = ' client/pyproject.toml | sed -E "s/version = ['\"](.*)['\"]/\1/" | xargs)
            echo "ğŸ“„ ä» pyproject.toml æå–çš„ç‰ˆæœ¬: $VERSION"
          fi
          
          # å»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦å’Œæ¢è¡Œç¬¦
          VERSION=$(echo -n "$VERSION" | tr -d '[:space:]')
          
          # å†æ¬¡ç¡®ä¿ç§»é™¤å¯èƒ½çš„ v å‰ç¼€
          VERSION="${VERSION#v}"
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ï¼ˆè¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼šx.y.zï¼‰
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ é”™è¯¯: æ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼: $VERSION"
            echo "   ç‰ˆæœ¬å·å¿…é¡»æ˜¯è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ¼å¼ï¼Œå¦‚: 0.1.2"
            exit 1
          fi
          
          # ä½¿ç”¨å¤šè¡Œè¾“å‡ºæ ¼å¼é¿å…æ¢è¡Œç¬¦é—®é¢˜
          {
            echo "version<<EOF"
            echo -n "$VERSION"
            echo ""
            echo "EOF"
          } >> $GITHUB_OUTPUT
          echo "âœ… æ„å»ºç‰ˆæœ¬: $VERSION"
      
      - name: éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
        working-directory: ./client
        run: |
          # ä» pyproject.toml è¯»å–ç‰ˆæœ¬ï¼ˆå»é™¤å‰åç©ºç™½ï¼‰
          PYPROJECT_VERSION=$(grep -E '^version = ' pyproject.toml | sed -E "s/version = ['\"](.*)['\"]/\1/" | xargs)
          WORKFLOW_VERSION="${{ steps.version.outputs.version }}"
          
          # å»é™¤ç©ºç™½å­—ç¬¦
          PYPROJECT_VERSION=$(echo "$PYPROJECT_VERSION" | tr -d '[:space:]')
          WORKFLOW_VERSION=$(echo "$WORKFLOW_VERSION" | tr -d '[:space:]')
          
          # ç¡®ä¿ç§»é™¤ v å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          PYPROJECT_VERSION="${PYPROJECT_VERSION#v}"
          WORKFLOW_VERSION="${WORKFLOW_VERSION#v}"
          
          echo "pyproject.toml ç‰ˆæœ¬: [$PYPROJECT_VERSION] (é•¿åº¦: ${#PYPROJECT_VERSION})"
          echo "Workflow ç‰ˆæœ¬: [$WORKFLOW_VERSION] (é•¿åº¦: ${#WORKFLOW_VERSION})"
          
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # Tag è§¦å‘æ—¶ï¼Œå¿…é¡»ä¸ pyproject.toml ä¸­çš„ç‰ˆæœ¬ä¸€è‡´
            if [[ "$PYPROJECT_VERSION" != "$WORKFLOW_VERSION" ]]; then
              echo "âŒ é”™è¯¯: tag ç‰ˆæœ¬ ($WORKFLOW_VERSION) ä¸ pyproject.toml ç‰ˆæœ¬ ($PYPROJECT_VERSION) ä¸ä¸€è‡´ï¼"
              echo "è°ƒè¯•ä¿¡æ¯:"
              echo "  PYPROJECT_VERSION hex: $(echo -n "$PYPROJECT_VERSION" | xxd -p)"
              echo "  WORKFLOW_VERSION hex: $(echo -n "$WORKFLOW_VERSION" | xxd -p)"
              exit 1
            fi
            echo "âœ… ç‰ˆæœ¬éªŒè¯é€šè¿‡: $WORKFLOW_VERSION"
          else
            echo "â„¹ï¸  é tag è§¦å‘ï¼Œä½¿ç”¨ pyproject.toml ç‰ˆæœ¬: $PYPROJECT_VERSION"
          fi
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…æ„å»ºå·¥å…·
        run: |
          python -m pip install --upgrade pip
          pip install build wheel
      
      - name: æ„å»º client åŒ…
        working-directory: ./client
        run: |
          echo "å¼€å§‹æ„å»ºç‰ˆæœ¬ ${{ steps.version.outputs.version }}..."
          python -m build
          echo "âœ… æ„å»ºå®Œæˆ"
      
      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©
        working-directory: ./client
        run: |
          echo "ğŸ“¦ æ„å»ºäº§ç‰©ï¼š"
          ls -lh dist/
          echo ""
          echo "ğŸ“‹ æ–‡ä»¶åˆ—è¡¨ï¼š"
          find dist -type f -exec ls -lh {} \;
          echo ""
          echo "ğŸ“Š æ–‡ä»¶å¤§å°ç»Ÿè®¡ï¼š"
          du -sh dist/*
      
      - name: éªŒè¯æ„å»ºäº§ç‰©
        working-directory: ./client
        run: |
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº† wheel å’Œ source distribution
          if [ ! -f "dist/py_auth_client-${{ steps.version.outputs.version }}-py3-none-any.whl" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° wheel æ–‡ä»¶"
            exit 1
          fi
          
          if [ ! -f "dist/py_auth_client-${{ steps.version.outputs.version }}.tar.gz" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° source distribution æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆArtifactï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: py-auth-client-${{ steps.version.outputs.version }}
          path: client/dist/*
          retention-days: 30
          if-no-files-found: error
      
      - name: åˆ›å»º GitHub Releaseï¼ˆä»… tag è§¦å‘ï¼‰
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: client/dist/*
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## py-auth-client v${{ steps.version.outputs.version }}
            
            ### ğŸ“¦ æ„å»ºäº§ç‰©
            
            - `py_auth_client-${{ steps.version.outputs.version }}-py3-none-any.whl` - Wheel åŒ…
            - `py_auth_client-${{ steps.version.outputs.version }}.tar.gz` - æºç åŒ…
            
            ### ğŸ“¥ å®‰è£…
            
            ```bash
            pip install py-auth-client==${{ steps.version.outputs.version }}
            ```
            
            ### ğŸ“š æŸ¥çœ‹å˜æ›´
            
            è¯·æŸ¥çœ‹ [CHANGELOG.md](../../CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´ã€‚
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

